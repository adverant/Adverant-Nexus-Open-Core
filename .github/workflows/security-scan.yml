name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full repository scan'
        required: false
        default: false
        type: boolean

jobs:
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    outputs:
      trufflehog_status: ${{ steps.trufflehog.outcome }}
      gitleaks_status: ${{ steps.gitleaks.outcome }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # TruffleHog with proper PR handling
      - name: TruffleHog Secret Scan (PR)
        id: trufflehog-pr
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: TruffleHog Secret Scan (Push)
        id: trufflehog-push
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.sha }}
          extra_args: --only-verified

      - name: TruffleHog Full Scan (Manual)
        id: trufflehog-full
        if: github.event_name == 'workflow_dispatch' && inputs.full_scan
        uses: trufflesecurity/trufflehog@main
        continue-on-error: true
        with:
          path: ./
          extra_args: --only-verified

      - name: Set TruffleHog Status
        id: trufflehog
        run: |
          if [[ "${{ steps.trufflehog-pr.outcome }}" == "failure" ]] || \
             [[ "${{ steps.trufflehog-push.outcome }}" == "failure" ]] || \
             [[ "${{ steps.trufflehog-full.outcome }}" == "failure" ]]; then
            echo "outcome=failure" >> $GITHUB_OUTPUT
          else
            echo "outcome=success" >> $GITHUB_OUTPUT
          fi

      # GitLeaks for additional coverage
      - name: GitLeaks Secret Detection
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Post results as PR comment
      - name: Post Security Results
        if: github.event_name == 'pull_request' && (steps.trufflehog.outputs.outcome == 'failure' || steps.gitleaks.outcome == 'failure')
        uses: actions/github-script@v7
        with:
          script: |
            const truffleStatus = '${{ steps.trufflehog.outputs.outcome }}';
            const gitleaksStatus = '${{ steps.gitleaks.outcome }}';

            let body = '## ðŸ” Security Scan Results\n\n';
            body += `| Scanner | Status |\n`;
            body += `|---------|--------|\n`;
            body += `| TruffleHog | ${truffleStatus === 'failure' ? 'âš ï¸ Issues Found' : 'âœ… Passed'} |\n`;
            body += `| GitLeaks | ${gitleaksStatus === 'failure' ? 'âš ï¸ Issues Found' : 'âœ… Passed'} |\n\n`;

            if (truffleStatus === 'failure' || gitleaksStatus === 'failure') {
              body += '> **Note**: Please review the scan results in the Actions tab and address any security findings before merging.\n';
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: audit
        run: |
          npm audit --audit-level=high --json > audit-results.json 2>&1 || true
          HIGH_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          echo "high=$HIGH_VULNS" >> $GITHUB_OUTPUT
          echo "critical=$CRITICAL_VULNS" >> $GITHUB_OUTPUT
          if [[ $CRITICAL_VULNS -gt 0 ]]; then
            echo "::error::Found $CRITICAL_VULNS critical vulnerabilities"
          fi
          if [[ $HIGH_VULNS -gt 0 ]]; then
            echo "::warning::Found $HIGH_VULNS high severity vulnerabilities"
          fi
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v6
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

  security-summary:
    name: Security Summary
    needs: [secret-scan, dependency-audit]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check security status
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
