# WARNING: Local builds prohibited on Mac (ARM64 incompatibility)
# This docker-compose file contains 'build:' directives
#
# ❌ DO NOT RUN: docker-compose build (will fail in production)
# ✅ INSTEAD USE: ~/.docker-enforcement/remote-build.sh <service>
#
# All Docker builds must be done on remote server: YOUR_SERVER_IP
# See CLAUDE.md for detailed instructions

version: '3.8'

services:
  graphrag:
    build:
      context: .
      dockerfile: Dockerfile.optimized
      target: development
      args:
        - NODE_VERSION=20
        - GIT_COMMIT=${GIT_COMMIT:-dev}
      cache_from:
        - type=registry,ref=localhost:32000/graphrag:buildcache
    image: graphrag:dev
    container_name: graphrag-dev
    restart: unless-stopped
    ports:
      - "8090:8090"  # API port
      - "8091:8091"  # WebSocket port
      - "9229:9229"  # Debug port
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      # Database connections
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: graphrag_dev
      POSTGRES_USER: graphrag
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      # Neo4j
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: ${NEO4J_PASSWORD:-devpassword}
      # Qdrant
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-devpassword}
      # Voyage AI
      VOYAGE_API_KEY: ${VOYAGE_API_KEY}
      VOYAGE_MODEL: voyage-3
      VOYAGE_CODE_MODEL: voyage-code-3
      VOYAGE_MULTIMODAL_MODEL: voyage-multimodal-3
      VOYAGE_RERANK_MODEL: rerank-2.5
    volumes:
      - ./src:/app/src:ro
      - ./migrations:/app/migrations:ro
      - ./logs:/app/logs
      - ./temp:/app/temp
      - node_modules:/app/node_modules
    depends_on:
      - postgres
      - neo4j
      - qdrant
      - redis
    networks:
      - graphrag-network
    command: ["npm", "run", "dev"]

  # Local development databases
  postgres:
    image: postgres:15-alpine
    container_name: graphrag-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: graphrag_dev
      POSTGRES_USER: graphrag
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-devpassword}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - graphrag-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U graphrag"]
      interval: 10s
      timeout: 5s
      retries: 5

  neo4j:
    image: neo4j:5-community
    container_name: graphrag-neo4j
    restart: unless-stopped
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD:-devpassword}
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_dbms_memory_heap_max__size: 2G
      NEO4J_dbms_memory_pagecache_size: 1G
    volumes:
      - neo4j_data:/data
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    networks:
      - graphrag-network
    healthcheck:
      test: ["CMD", "neo4j-admin", "dbms", "check"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:latest
    container_name: graphrag-qdrant
    restart: unless-stopped
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
    volumes:
      - qdrant_data:/qdrant/storage
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    networks:
      - graphrag-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: graphrag-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-devpassword}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - graphrag-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Optional: Adminer for database management
  adminer:
    image: adminer:latest
    container_name: graphrag-adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - graphrag-network
    depends_on:
      - postgres

networks:
  graphrag-network:
    driver: bridge
    name: graphrag-dev-network

volumes:
  postgres_data:
    name: graphrag-postgres-data
  neo4j_data:
    name: graphrag-neo4j-data
  qdrant_data:
    name: graphrag-qdrant-data
  redis_data:
    name: graphrag-redis-data
  node_modules:
    name: graphrag-node-modules