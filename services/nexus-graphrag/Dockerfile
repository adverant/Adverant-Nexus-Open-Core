# Multi-stage production Dockerfile for GraphRAG service
# Optimized for layer caching and minimal image size

# Base stage with common dependencies
FROM --platform=linux/amd64 node:20-alpine AS base
RUN apk add --no-cache \
    tini \
    curl \
    && rm -rf /var/cache/apk/*
WORKDIR /app

# Dependencies stage - cached unless package.json changes
FROM --platform=linux/amd64 base AS deps
RUN apk add --no-cache python3 make g++ git

# Copy GraphRAG's package.json (WITHOUT workspace package references)
COPY services/nexus-graphrag/package*.json ./

# Install all dependencies EXCEPT workspace packages
# This approach avoids npm hanging on complex dependency resolution
# Also install tsx here so we don't need to install it later (which would reinstall deps)
RUN npm install && \
    npm install --save tsx && \
    npm cache clean --force && \
    cp -R node_modules prod_node_modules

# Build stage - prepare GraphRAG source only
# Workspace packages are pre-built on host and will be copied in production stage
FROM --platform=linux/amd64 deps AS builder
COPY services/nexus-graphrag/tsconfig*.json ./
COPY services/nexus-graphrag/src/ ./src/
COPY services/nexus-graphrag/migrations/ ./migrations/

# No workspace package compilation needed - they're pre-built on host
RUN echo "GraphRAG source prepared for tsx runtime"

# Development stage with hot reload and debugging
FROM --platform=linux/amd64 base AS development
RUN apk add --no-cache \
    python3 \
    make \
    g++ \
    git \
    postgresql-client \
    bash
RUN npm install -g ts-node ts-node-dev nodemon
COPY services/nexus-graphrag/package*.json services/nexus-graphrag/tsconfig*.json ./
RUN npm install
COPY services/nexus-graphrag/src/ ./src/
COPY services/nexus-graphrag/migrations/ ./migrations/
EXPOSE 8090 8091 9229
ENV NODE_ENV=development
CMD ["npm", "run", "dev"]

# Test stage for running tests
FROM --platform=linux/amd64 development AS test
COPY services/nexus-graphrag/tests/ ./tests/
COPY services/nexus-graphrag/jest.config.js ./
RUN npm test

# Production stage - minimal final image
FROM --platform=linux/amd64 base AS production

# Install runtime dependencies including Python for Docling
RUN apk add --no-cache \
    postgresql-client \
    python3 \
    py3-pip \
    tesseract-ocr \
    tesseract-ocr-data-eng \
    poppler-utils \
    && addgroup -g 1001 -S nodejs \
    && adduser -S nodejs -u 1001

WORKDIR /app

# Install Python packages for document processing
# Note: Skipping Docling due to complex dependencies on Alpine
# Will use fallback processors (PyPDF2, python-docx, etc.)
RUN pip3 install --break-system-packages --no-cache-dir \
    pytesseract \
    Pillow \
    pdf2image \
    pypdf2 \
    python-docx \
    openpyxl \
    pdfplumber \
    && rm -rf /root/.cache/pip

# Copy production dependencies from deps stage
COPY --from=deps --chown=nodejs:nodejs /app/prod_node_modules ./node_modules

# Remove any potential symlinks for workspace packages (if they exist)
RUN rm -rf node_modules/@adverant/logger node_modules/@adverant/database node_modules/@adverant/resilience \
    node_modules/@adverant/cache node_modules/@adverant/config node_modules/@adverant/errors \
    node_modules/@unified-nexus/voyage-ai-client

# Copy package.json for sed transformation (needed before installing workspace packages)
COPY --chown=nodejs:nodejs services/nexus-graphrag/package*.json ./

# COPY workspace package tarballs (.tgz files generated by pack-workspace-packages.sh)
# These are NOT excluded by .gitignore, so Docker will include them in build context
COPY --chown=nodejs:nodejs adverant-logger-*.tgz /tmp/
COPY --chown=nodejs:nodejs adverant-database-*.tgz /tmp/
COPY --chown=nodejs:nodejs adverant-resilience-*.tgz /tmp/
COPY --chown=nodejs:nodejs adverant-cache-*.tgz /tmp/
COPY --chown=nodejs:nodejs adverant-config-*.tgz /tmp/
COPY --chown=nodejs:nodejs adverant-errors-*.tgz /tmp/
COPY --chown=nodejs:nodejs unified-nexus-voyage-ai-client-*.tgz /tmp/

# Install workspace packages from tarballs
# CRITICAL: Remove workspace references from package.json first to prevent npm from
# removing existing dependencies. npm sees "file:../../packages/*" and removes packages
# that don't match this specification, even with --no-save flag.
RUN sed -i.bak \
    -e 's|"@adverant/logger": "file:../../packages/adverant-logger"|"@adverant/logger": "*"|' \
    -e 's|"@adverant/database": "file:../../packages/adverant-database"|"@adverant/database": "*"|' \
    -e 's|"@adverant/resilience": "file:../../packages/adverant-resilience"|"@adverant/resilience": "*"|' \
    -e 's|"@adverant/cache": "file:../../packages/adverant-cache"|"@adverant/cache": "*"|' \
    -e 's|"@adverant/config": "file:../../packages/adverant-config"|"@adverant/config": "*"|' \
    -e 's|"@adverant/errors": "file:../../packages/adverant-errors"|"@adverant/errors": "*"|' \
    -e 's|"@unified-nexus/voyage-ai-client": "file:../../packages/voyage-ai-client"|"@unified-nexus/voyage-ai-client": "*"|' \
    package.json && \
    npm install --no-save \
    /tmp/adverant-logger-*.tgz \
    /tmp/adverant-database-*.tgz \
    /tmp/adverant-resilience-*.tgz \
    /tmp/adverant-cache-*.tgz \
    /tmp/adverant-config-*.tgz \
    /tmp/adverant-errors-*.tgz \
    /tmp/unified-nexus-voyage-ai-client-*.tgz

# Copy source files from builder (not compiled)
COPY --from=builder --chown=nodejs:nodejs /app/src ./src
COPY --from=builder --chown=nodejs:nodejs /app/migrations ./migrations
COPY --from=builder --chown=nodejs:nodejs /app/tsconfig*.json ./

# Copy package.json for reference
# Note: Workspace packages already in node_modules from deps stage
COPY --chown=nodejs:nodejs services/nexus-graphrag/package*.json ./

# Copy Python scripts
COPY --chown=nodejs:nodejs services/nexus-graphrag/scripts/ ./scripts/

# Create directories and set permissions (tsx already in prod_node_modules from deps stage)
USER root
RUN rm -f /tmp/*.tgz && \
    mkdir -p /app/logs /app/temp /var/log/graphrag && \
    chown -R nodejs:nodejs /app /var/log/graphrag

# Copy and setup entrypoint script
COPY --chown=nodejs:nodejs services/nexus-graphrag/docker-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Switch to non-root user
USER nodejs

# Expose application ports
EXPOSE 8090 8091

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8090/health || exit 1

# Environment variables
ENV NODE_ENV=production \
    PORT=8090 \
    WS_PORT=8091 \
    LOG_LEVEL=info

# Use tini for proper signal handling
ENTRYPOINT ["/sbin/tini", "--"]
CMD ["/usr/local/bin/docker-entrypoint.sh"]