apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mageagent-network-policy
  namespace: mage-agent
spec:
  podSelector:
    matchLabels:
      app: mageagent
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow traffic from Istio ingress gateway
  - from:
    - namespaceSelector:
        matchLabels:
          name: istio-system
    ports:
    - protocol: TCP
      port: 3001
  # Allow traffic from other pods in the same namespace
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 3001
  egress:
  # Allow DNS resolution
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: UDP
      port: 53
  # Allow access to databases in vibe-data namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: vibe-data
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 7687  # Neo4j Bolt
    - protocol: TCP
      port: 7474  # Neo4j HTTP
    - protocol: TCP
      port: 6333  # Qdrant
  # Allow access to GraphRAG in vibe-system namespace
  - to:
    - namespaceSelector:
        matchLabels:
          name: vibe-system
    ports:
    - protocol: TCP
      port: 8080  # GraphRAG
  # Allow external API calls (OpenRouter, etc)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 80